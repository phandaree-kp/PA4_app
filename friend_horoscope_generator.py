import streamlit as st
import openai
import pandas as pd
import json

#sidebar à¸ªà¸³à¸«à¸£à¸±à¸šà¹ƒà¸ªà¹ˆ API Key
user_api_key = st.sidebar.text_input("ðŸ”‘ à¸à¸£à¸¸à¸“à¸²à¸à¸£à¸­à¸ OpenAI API Key(ã……Â´ Ë˜ `)", type="password")

prompt_template = """
à¸ªà¸¡à¸¡à¸•à¸´à¸§à¹ˆà¸²à¸„à¸¸à¸“à¹€à¸›à¹‡à¸™à¸™à¸±à¸à¸žà¸¢à¸²à¸à¸£à¸“à¹Œà¸”à¸§à¸‡à¸—à¸µà¹ˆà¹€à¸™à¹‰à¸™à¸„à¸³à¸—à¸³à¸™à¸²à¸¢à¹à¸šà¸šà¸›à¸±à¹ˆà¸™ à¸‚à¸³à¸‚à¸±à¸™à¸ªà¸¸à¸” à¹† à¸®à¸²à¸™à¹‰à¸³à¸•à¸²à¹€à¸¥à¹‡à¸” 
à¸„à¸¸à¸“à¸ˆà¸°à¹„à¸”à¹‰à¸£à¸±à¸šà¸Šà¸·à¹ˆà¸­à¹€à¸žà¸·à¹ˆà¸­à¸™ à¸§à¸±à¸™à¹€à¸à¸´à¸” (à¸§à¸±à¸™à¹ƒà¸™à¸ªà¸±à¸›à¸”à¸²à¸«à¹Œ) à¹à¸¥à¸°à¸™à¸´à¸ªà¸±à¸¢à¸‚à¸­à¸‡à¹€à¸žà¸·à¹ˆà¸­à¸™
à¸ªà¸£à¹‰à¸²à¸‡à¸„à¸³à¸—à¸³à¸™à¸²à¸¢à¸ªà¸¸à¸”à¸®à¸²à¹ƒà¸™ 5 à¸«à¸¡à¸§à¸”à¸”à¸±à¸‡à¸™à¸µà¹‰:
1. à¸à¸²à¸£à¸‡à¸²à¸™
2. à¸à¸²à¸£à¹€à¸‡à¸´à¸™
3. à¸ªà¸¸à¸‚à¸ à¸²à¸ž
4. à¸„à¸§à¸²à¸¡à¸£à¸±à¸
5. à¹‚à¸Šà¸„à¸¥à¸²à¸ 
à¸ˆà¸²à¸à¸™à¸±à¹‰à¸™à¸ªà¹ˆà¸‡à¸„à¸³à¸—à¸³à¸™à¸²à¸¢à¹ƒà¸™à¸£à¸¹à¸›à¹à¸šà¸š JSON array à¸—à¸µà¹ˆà¸¡à¸µà¹‚à¸„à¸£à¸‡à¸ªà¸£à¹‰à¸²à¸‡à¸”à¸±à¸‡à¸•à¹ˆà¸­à¹„à¸›à¸™à¸µà¹‰ à¸•à¸±à¸§à¸­à¸¢à¹ˆà¸²à¸‡à¹€à¸Šà¹ˆà¸™:
[
    {"category": "à¸à¸²à¸£à¸‡à¸²à¸™", "prediction": "à¹€à¸ˆà¹‰à¸²à¸™à¸²à¸¢à¸Šà¸¡à¹€à¸Šà¸¢! ( â€¢ Ì€Ï‰â€¢Ì )âœ§ à¹à¸•à¹ˆà¹„à¸¡à¹ˆà¹„à¸”à¹‰à¸‚à¸¶à¹‰à¸™à¹€à¸‡à¸´à¸™à¹€à¸”à¸·à¸­à¸™ â•¥â€¸â•¥"},
    {"category": "à¸à¸²à¸£à¹€à¸‡à¸´à¸™", "prediction": "à¹„à¸”à¹‰à¹€à¸‡à¸´à¸™à¸¡à¸²à¹„à¸§ãƒ¾(ï½¡âœªÏ‰âœªï½¡)ï½¼ðŸ’° à¹à¸•à¹ˆà¸«à¸¡à¸”à¹„à¸›à¹„à¸§à¸à¸§à¹ˆà¸² âˆ˜ âˆ˜ âˆ˜ ðŸ’¸( Â°ãƒ®Â° ) ?"},
    {"category": "à¸ªà¸¸à¸‚à¸ à¸²à¸ž", "prediction": "à¸›à¸§à¸”à¸«à¸¥à¸±à¸‡à¹€à¸žà¸£à¸²à¸°à¸™à¸±à¹ˆà¸‡à¹€à¸¥à¹ˆà¸™à¹€à¸à¸¡à¸ªà¹Œà¸¢à¸±à¸™à¹€à¸Šà¹‰à¸² ( Tá—œT)ðŸŽ®"},
    {"category": "à¸„à¸§à¸²à¸¡à¸£à¸±à¸", "prediction": "à¸„à¸™à¹‚à¸ªà¸”à¸ˆà¸°à¹€à¸ˆà¸­à¸„à¸™à¸–à¸¹à¸à¹ƒà¸ˆ (ï½¡>\\<) à¹à¸•à¹ˆà¹€à¸‚à¸²à¸”à¸±à¸™à¸¡à¸µà¹à¸Ÿà¸™à¹à¸¥à¹‰à¸§..."},
    {"category": "à¹‚à¸Šà¸„à¸¥à¸²à¸ ", "prediction": "à¹‚à¸Šà¸„à¸¥à¸²à¸ à¸à¸³à¸¥à¸±à¸‡à¸£à¸­à¸„à¸¸à¸“à¸­à¸¢à¸¹à¹ˆà¹ƒà¸™à¸¡à¸¸à¸¡à¸—à¸µà¹ˆà¹„à¸¡à¹ˆà¸„à¸²à¸”à¸„à¸´à¸”â€”à¸­à¸²à¸ˆà¸ˆà¸°à¹€à¸›à¹‡à¸™à¹€à¸‡à¸´à¸™à¹ƒà¸™à¹€à¸„à¸£à¸·à¹ˆà¸­à¸‡à¸‹à¸±à¸à¸œà¹‰à¸²à¸—à¸µà¹ˆà¸¥à¸·à¸¡à¸«à¸¢à¸´à¸šà¸­à¸­à¸à¸ˆà¸²à¸à¸à¸£à¸°à¹€à¸›à¹‹à¸²à¸à¸²à¸‡à¹€à¸à¸‡!ðŸ§ºðŸ§¼"}
]
à¹„à¸¡à¹ˆà¸•à¹‰à¸­à¸‡à¸­à¸˜à¸´à¸šà¸²à¸¢à¹€à¸žà¸´à¹ˆà¸¡à¹€à¸•à¸´à¸¡ à¸ªà¹ˆà¸‡à¹à¸„à¹ˆ JSON array à¹€à¸—à¹ˆà¸²à¸™à¸±à¹‰à¸™
""" 

#à¸ªà¹ˆà¸§à¸™à¸«à¸±à¸§à¸‚à¸­à¸‡à¹à¸­à¸›
st.title("à¸£à¸°à¸šà¸šà¸žà¸¢à¸²à¸à¸£à¸“à¹Œà¸”à¸§à¸‡à¹€à¸žà¸·à¹ˆà¸­à¸™à¹à¸šà¸šà¸›à¸±à¹ˆà¸™ ðŸ”¥ðŸ”®ðŸŒŸ")
st.write("à¸à¸£à¸­à¸à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹€à¸žà¸·à¹ˆà¸­à¸™à¸‚à¸­à¸‡à¸„à¸¸à¸“ ðŸ‘§ðŸ»ðŸ§’ðŸ»ðŸ’ž (à¸ªà¸¹à¸‡à¸ªà¸¸à¸” 5 à¸„à¸™) à¹€à¸žà¸·à¹ˆà¸­à¸”à¸¹à¸„à¸³à¸—à¸³à¸™à¸²à¸¢à¸ªà¸¸à¸”à¸®à¸²!")

#à¸à¸£à¸­à¸à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹€à¸žà¸·à¹ˆà¸­à¸™à¸—à¸µà¸¥à¸°à¸„à¸™ (à¸ªà¸¹à¸‡à¸ªà¸¸à¸” 5 à¸„à¸™)
friends_data = []
for i in range(1, 6):
    st.subheader(f"à¹€à¸žà¸·à¹ˆà¸­à¸™à¸„à¸™à¸—à¸µà¹ˆ {i} ðŸƒðŸ»â€â™‚ï¸ðŸ’¨")
    friend_name = st.text_input(f"à¸Šà¸·à¹ˆà¸­à¹€à¸žà¸·à¹ˆà¸­à¸™à¸„à¸™à¸—à¸µà¹ˆ {i}", key=f"name_{i}")
    birthday = st.selectbox(f"à¸§à¸±à¸™à¹€à¸à¸´à¸”à¸„à¸™à¸—à¸µà¹ˆ {i}", 
                            ["à¸§à¸±à¸™à¸­à¸²à¸—à¸´à¸•à¸¢à¹Œ", "à¸§à¸±à¸™à¸ˆà¸±à¸™à¸—à¸£à¹Œ", "à¸§à¸±à¸™à¸­à¸±à¸‡à¸„à¸²à¸£", 
                             "à¸§à¸±à¸™à¸žà¸¸à¸˜", "à¸§à¸±à¸™à¸žà¸¤à¸«à¸±à¸ªà¸šà¸”à¸µ", "à¸§à¸±à¸™à¸¨à¸¸à¸à¸£à¹Œ", "à¸§à¸±à¸™à¹€à¸ªà¸²à¸£à¹Œ"], 
                            key=f"birthday_{i}")
    behavior = st.text_input(f"à¸™à¸´à¸ªà¸±à¸¢à¸«à¸£à¸·à¸­à¸žà¸¤à¸•à¸´à¸à¸£à¸£à¸¡à¹€à¸”à¹ˆà¸™à¸‚à¸­à¸‡à¹€à¸žà¸·à¹ˆà¸­à¸™à¸„à¸™à¸—à¸µà¹ˆ {i}", 
                             placeholder="à¹€à¸Šà¹ˆà¸™ à¸Šà¸­à¸šà¹€à¸šà¸µà¹‰à¸¢à¸§à¸™à¸±à¸” à¸•à¸´à¸”à¹à¸Ÿà¸™ à¸•à¸­à¸™à¹€à¸¡à¸²à¹€à¸„à¸¢à¸­à¸¸à¹‰à¸¡à¸«à¸¡à¸²à¸à¸¥à¸±à¸šà¸šà¹‰à¸²à¸™", key=f"behavior_{i}")
    
    if friend_name and birthday and behavior:
        friends_data.append({
            "name": friend_name,
            "birthday": birthday,
            "behavior": behavior
        })

#à¸›à¸¸à¹ˆà¸¡à¸à¸”à¹€à¸žà¸·à¹ˆà¸­à¸‚à¸­à¸„à¸³à¸—à¸³à¸™à¸²à¸¢
if st.button("(à¹‘'áµ•'à¹‘)â¸*ðŸ”® à¸”à¸¹à¸”à¸§à¸‡à¸‡!"):
    if not user_api_key:
        st.error("à¸à¸£à¸¸à¸“à¸²à¹ƒà¸ªà¹ˆ API Key à¸à¹ˆà¸­à¸™à¸™à¸°à¸‡à¸±à¹‰à¸Ÿ! (ã…… â€¢á·„ â‚ƒâ€¢á·… )")
    elif not friends_data:
        st.error("à¸à¸£à¸¸à¸“à¸²à¸à¸£à¸­à¸à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹€à¸žà¸·à¹ˆà¸­à¸™à¸­à¸¢à¹ˆà¸²à¸‡à¸™à¹‰à¸­à¸¢ 1 à¸„à¸™à¸™à¹‰à¸²~ (ï½¡- .â€¢Ì€ )âŸ¡Ë– à£ªâ‹†")
    else:
        st.info("â³ à¸à¸³à¸¥à¸±à¸‡à¸ªà¸£à¹‰à¸²à¸‡à¹€à¸£à¸·à¹ˆà¸­à¸‡ à¹€à¸­à¹‰à¸¢! à¸ªà¸£à¹‰à¸²à¸‡à¸„à¸³à¸—à¸³à¸™à¸²à¸¢... à¹‚à¸›à¸£à¸”à¸£à¸­à¸ªà¸±à¸à¸„à¸£à¸¹à¹ˆ à¸•à¸£à¸¹à¹‰à¸”à¹†")
        openai.api_key = user_api_key
        
        results = []
        for friend in friends_data:
            name, birthday, behavior = friend["name"], friend["birthday"], friend["behavior"]
            messages = [
                {"role": "system", "content": prompt_template},
                {"role": "user", "content": f"à¸Šà¸·à¹ˆà¸­: {name}, à¸§à¸±à¸™à¹€à¸à¸´à¸”: {birthday}, à¸™à¸´à¸ªà¸±à¸¢: {behavior}"}
            ]
            
            try:
                response = openai.ChatCompletion.create(
                    model = "gpt-4o-mini", #à¸£à¸­à¸”à¸¹à¸­à¸µà¸à¸—à¸µà¸§à¹ˆà¸²à¸ˆà¸²à¸‹à¸·à¹‰à¸­ model à¸•à¸¸à¸§à¹„à¸«à¸™ à¹€à¸«à¸¡à¸·à¸­à¸™à¸„à¸³à¸ªà¸±à¹ˆà¸‡à¸•à¸£à¸‡ response à¸ˆà¸°à¹„à¸¡à¹ˆà¹€à¸«à¸¡à¸·à¸­à¸™à¸à¸±à¸™à¸”à¹‰à¸§à¸¢
                    messages = messages
                )
                horoscope_json = response.choices[0].message['content']
                horoscope_list = json.loads(horoscope_json)
                
                for prediction in horoscope_list:
                    results.append({
                        "Name": name,
                        "Birthday": birthday,
                        "Behavior": behavior,
                        "Category": prediction["category"],
                        "Prediction": prediction["prediction"]
                    })
            except Exception as e:
                results.append({
                    "Name": name,
                    "Birthday": birthday,
                    "Behavior": behavior,
                    "Category": "Error",
                    "Prediction": str(e)
                })

        #à¸ªà¸£à¹‰à¸²à¸‡ DataFrame
        df = pd.DataFrame(results)
        
        #à¹à¸ªà¸”à¸‡à¸œà¸¥
        st.subheader("ðŸ“‹ à¸„à¸³à¸—à¸³à¸™à¸²à¸¢à¹ƒà¸™à¸£à¸¹à¸›à¹à¸šà¸šà¸•à¸²à¸£à¸²à¸‡")
        st.dataframe(df)

        #à¸”à¸²à¸§à¸™à¹Œà¹‚à¸«à¸¥à¸” CSV
        csv = df.to_csv(index=False).encode('utf-8')
        st.download_button(
            label = "ðŸ“¥ à¸”à¸²à¸§à¸™à¹Œà¹‚à¸«à¸¥à¸”à¸„à¸³à¸—à¸³à¸™à¸²à¸¢ (CSV)",
            data = csv,
            file_name ="friends_horoscope.csv",
            mime ='text/csv'
        )
